# 心理健康助手（Mental Health Assistant）

本项目是一套面向校园/大学生场景的心理健康辅助系统，提供 **AI智能咨询（流式对话）**、**情绪日记与AI情绪分析**、**心理知识库**、**后台数据分析与运营管理** 等能力。整体采用前后端分离架构：前端 `Vue 3 + Vite`，后端 `Spring Boot 3`，数据存储 `MySQL`（可选 `Redis` 缓存），AI能力通过 `Spring AI` 对接 OpenAI 兼容接口（示例接入硅基流动 SiliconFlow）。

---

## 1. 项目结构

- `springboot/`：后端（Spring Boot）  
- `vue3/`：前端（Vue 3 + Vite），包含前台用户端与后台管理端  
- `mental_health_assistant.sql`：数据库建表与示例数据  
- `AI服务配置说明.txt`：AI服务（API Key/模型）配置指引  
- `assets/`、`css/`：静态资源/样式资源（如有）  

---

## 2. 系统架构概览

```
┌───────────────┐        HTTP/JSON + SSE         ┌────────────────────┐
│ Vue3 前端     │  <──────────────────────────>  │ Spring Boot 后端    │
│ - 用户端      │                                │ - REST API(/api/*)  │
│ - 管理端      │                                │ - SSE流式输出        │
└──────┬────────┘                                └───────┬────────────┘
       │                                                 │
       │                                                 │
       │                                         ┌───────┴────────────┐
       │                                         │ MySQL               │
       │                                         │ - 业务数据/会话/日记 │
       │                                         └────────┬───────────┘
       │                                                  │
       │                                         ┌────────┴───────────┐
       │                                         │ AI(兼容OpenAI接口)  │
       │                                         │ - 对话生成/情绪分析   │
       │                                         └────────────────────┘
       │
       │ (可选)
       │                                         ┌────────────────────┐
       └────────────────────────────────────────>│ Redis               │
                                                 │ - 缓存/会话数据等    │
                                                 └────────────────────┘
```

关键实现要点：
- 后端通过 `WebConfig` 对所有 `@RestController` 统一加 `/api` 前缀（例如：`/user/login` 实际访问为 `/api/user/login`）。
- AI咨询采用 **SSE（Server-Sent Events）** 流式返回，提升对话体验与实时性。
- 业务数据以 `MySQL` 为主，包含用户、咨询会话/消息、情绪日记、知识库、AI分析任务等。

---

## 3. 核心功能（按模块）

### 3.1 用户与权限

- 注册/登录、退出登录、忘记密码（邮箱找回）
- 个人中心：资料编辑、密码修改
- 角色与权限控制：普通用户 vs 管理员（前端路由与后端接口均有控制）
- 身份认证：JWT（`Authorization: Bearer <token>`）

### 3.2 AI智能咨询（流式对话）

面向用户提供“心理疏导式”对话能力，核心特性：
- **开始会话**：创建咨询会话并保存初始消息
- **流式对话**：以 SSE 逐段返回模型生成内容，前端可边接收边渲染
- **语音输入（STT）**：聊天输入框支持录音并转文字后再发送（接口：`/api/speech/stt`）
- **会话管理**：会话列表、详情、消息列表、删除会话、修改会话标题
- **情绪状态**：会话维度保存“最近一次情绪分析结果”，前端可展示用户当前情绪与风险提示

### 3.3 情绪日记与AI分析

帮助用户记录每日情绪并做趋势分析：
- 情绪日记：创建/更新/删除/详情查询、按日期获取、分页筛选（日期区间/评分/主要情绪/睡眠/压力等）
- 统计分析：按天数统计情绪分布、均值、趋势等
- **自动触发AI情绪分析**：当日记内容存在时，异步触发情绪分析并回写结果（避免阻塞用户提交）
- 管理端支持：日记分页、统计概览、管理员触发AI分析/批量分析等

### 3.4 AI分析任务队列（可观测 + 可重试）

为“日记AI分析”等耗时任务提供队列化管理能力：
- 任务状态：`PENDING / PROCESSING / COMPLETED / FAILED`
- 任务类型：自动/手动/管理员/批量触发等
- 失败重试：支持单个重试与批量重试，带最大重试次数与错误信息记录
- 管理端可查看队列统计、筛选失败/可重试任务

### 3.5 心理知识库（内容管理 + 收藏）

提供心理健康相关科普内容的管理与阅读：
- 分类管理：分类树、分页、CRUD（管理员）
- 文章管理：文章CRUD、发布/下线、阅读计数、标签、封面图、分页搜索/筛选/排序
- 收藏功能：用户收藏/取消收藏、收藏状态、收藏分页与数量统计

### 3.6 后台数据分析（运营视角）

面向管理员提供多维数据看板（天数可配置）：
- 系统概览：用户总数/活跃用户、日记数、会话数、平均情绪评分、今日新增等
- 情绪热力图：按星期/小时统计情绪记录密度与平均心情
- 情绪趋势：按日期聚合的趋势数据
- 咨询统计：会话与消息相关统计
- 用户活跃度：在指定时间窗口内的行为活跃情况

### 3.7 文件与资源

- 文件上传与静态资源映射：`/files/**` 映射到本地 `./files/`（用于头像、文章封面、附件等）
- 支持临时文件、业务文件归档（见 `sys_file_info` 表与 `FileController` 接口）

---

## 4. 关键业务流程（简述）

### 4.1 AI咨询（SSE）流程

1. 用户创建会话：保存会话记录与初始消息  
2. 用户发送消息：后端将消息写入数据库 + 写入 `ChatMemory`（窗口记忆）  
3. 后端调用 `Spring AI ChatClient` 流式生成内容，并以 SSE 连续返回片段  
4. 流式结束：保存完整AI回复、写入 `ChatMemory`  
5. 异步情绪分析：对用户消息做情绪/风险评估并回写到会话表，供前端展示

### 4.2 情绪日记 AI分析流程

1. 用户创建/更新日记（同一用户同一天最多一条，存在则更新）  
2. 若日记正文存在：异步创建AI分析任务并执行分析  
3. 任务状态流转：待处理 → 处理中 → 完成/失败（失败可重试）  
4. 将AI分析结果写回日记/任务记录，用于用户端展示与管理端统计

---

## 5. 技术栈与关键依赖

### 5.1 后端（`springboot/`）

- 语言/运行时：`Java 17`
- 框架：`Spring Boot 3.4.1`
- Web：Spring MVC、SSE（流式接口）、（依赖中包含 WebSocket Starter）
- 安全：Spring Security + JWT（`java-jwt`）
- 数据层：MyBatis-Plus + MySQL
- 缓存：Spring Data Redis（可选）
- AI：Spring AI `ChatClient` + OpenAI兼容接口适配（可配置模型/路径/base-url）
- 工具与组件：Hutool、Fastjson2
- API文档：SpringDoc + Knife4j（`/doc.html`）
- 其他：Spring Mail、AOP、（依赖中包含 Alipay SDK）

### 5.2 前端（`vue3/`）

- `Vue 3` + `Vite`
- UI：`Element Plus`
- 状态管理：`Pinia`（同时保留 `Vuex` 依赖）
- 路由：`vue-router`
- 请求：`axios`
- 图表：`ECharts`、`Chart.js`
- 富文本：`wangeditor`
- 流式通信：`@microsoft/fetch-event-source`（用于SSE）
- 可视化：`three`

### 5.3 数据库与表设计（核心表）

来自 `mental_health_assistant.sql` 的核心业务表：
- `user`：用户与角色/状态信息
- `emotion_diary`：情绪日记（含AI分析结果字段）
- `ai_analysis_task`：AI分析任务队列（状态、类型、优先级、重试次数、错误信息）
- `consultation_session`：咨询会话（含最近情绪分析JSON）
- `consultation_message`：咨询消息（用户/AI、内容、情绪标签、模型等）
- `knowledge_category`：知识分类（支持树结构）
- `knowledge_article`：知识文章（状态、发布时间、阅读数、标签、封面等）
- `user_favorite`：用户收藏（文章维度）
- `sys_file_info`：文件记录（业务类型/临时文件/过期时间等）

---

## 6. 项目创新点（可用于答辩/说明）

1. **流式心理疏导对话体验**：基于 SSE 的逐字/逐段输出，显著降低“等待感”，更贴近真实咨询交流节奏。
2. **“对话 + 情绪分析 + 风险分级”一体化闭环**：对用户文本进行结构化情绪识别（情绪类型/强度/关键词/建议/风险等级），并将结果回写到会话/日记，支持持续追踪。
3. **异步AI分析任务队列**：把AI分析从主链路剥离为可观测任务队列，支持失败重试与批量操作，提升系统稳定性与可运营性。
4. **数据驱动的管理后台**：从“用户活跃/咨询/日记/情绪趋势”多维度输出指标，支持运营和心理健康教育管理决策。
5. **内容体系与个性化沉淀**：知识库（分类树 + 富文本）结合收藏体系，将“即时咨询”与“长期学习/自助”结合，提升复访与沉淀效果。
6. **OpenAI兼容接口可替换**：通过 Spring AI 抽象与配置化模型参数，可在不同兼容服务之间切换（如 SiliconFlow / 其他兼容提供商）。

---

## 7. 配置与运行（简要）

### 7.1 后端启动

- 进入 `springboot/`，使用 Maven Wrapper 启动（Windows）：
  - `mvnw.cmd spring-boot:run`
- 默认端口：`1235`
- API文档：`/doc.html`

### 7.2 前端启动

- 进入 `vue3/`：
  - `npm install`
  - `npm run dev`

### 7.3 AI与数据库配置

- AI配置见 `AI服务配置说明.txt`
- 数据库初始化：导入 `mental_health_assistant.sql` 到本地 MySQL，并在 `springboot/src/main/resources/application.yml` 配置数据库连接与 `spring.ai.*` 参数（请自行填写密钥等敏感信息）。

### 7.4 实时语音对话（PsyGPT + LiveKit）

本仓库包含 `PsyGPT-main/`（Python 语音Agent）与 Web 项目（Vue3 + Spring Boot）。实时语音对话的推荐架构是：

- Web 前端：加入 LiveKit 房间、采集麦克风、播放 AI 的远端音频
- Web 后端：签发 LiveKit access token（避免把 `API_SECRET` 暴露给前端）
- `PsyGPT-main`：作为独立语音服务运行，在房间内完成 VAD/STT/LLM/TTS 并发布语音回复

**后端配置**
- 在系统环境变量或启动参数中配置（不要提交到仓库）：
  - `LIVEKIT_URL`
  - `LIVEKIT_API_KEY`
  - `LIVEKIT_API_SECRET`
- 后端接口：`GET /api/livekit/token?roomName=xxx`（前端加入房间前调用）

**前端配置**
- 依赖：`livekit-client`
- AI咨询页提供“实时语音对话”按钮，进入房间后自动发布本地麦克风音轨，并自动播放远端音轨。

**PsyGPT-main 配置与音色克隆**
- 在 `PsyGPT-main/.env.local` 配置 LiveKit 与模型服务 Key/Base URL（本地文件，不要提交）
- 参考 `PsyGPT-main/readme.md`：
  1) 用 `PsyGPT-main/upload_ref_voice.py` 上传 10–30 秒参考音频，获得 `speech id`
  2) 在 `PsyGPT-main/PsyGPT.py` 的 TTS `voice="speech:..."` 使用该 `speech id`，即可克隆音色
  3) 启动：`python PsyGPT.py start`

---

## 8. 安全提示（建议）

- 仓库内如包含数据库密码、AI API Key 等敏感信息，建议尽快 **更换密钥并改为环境变量/本地配置**，避免泄露风险。
